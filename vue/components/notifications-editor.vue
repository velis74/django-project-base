<script setup lang="ts">
import {
  Action,
  APIConsumer,
  ComponentDisplay,
  ConsumerLogicApi, FormConsumerOneShotApi, FormPayload, gettext,
  useActionHandler,
} from '@velis/dynamicforms';
import { onMounted, onUnmounted, ref } from 'vue';

import { apiClient } from '../api-client';
import {
  closeNotification,
  showNotification,
} from '../notifications';

const props = defineProps<{
  consumerUrl: {
    type: String,
    required: false,
  },
  consumerUrlTrailingSlash: {
    type: Boolean,
    required: false,
  },
  licenseConsumerUrl: {
    type: String,
    required: false,
  },
  licenseConsumerUrlTrailingSlash: {
    type: Boolean,
    required: false,
  },
}>();

const consumerUrl: string = (props.consumerUrl !== undefined ? props.consumerUrl : 'notification') as string;
const consumerTrailingSlash = (
    props.consumerUrlTrailingSlash !== undefined ? props.consumerUrlTrailingSlash : true) as boolean;

const licenseConsumerUrl = (
    props.licenseConsumerUrl !== undefined ? props.licenseConsumerUrl : 'notification-license') as string;
const licenseConsumerUrlTrailingSlash = (
    props.licenseConsumerUrlTrailingSlash !== undefined ? props.licenseConsumerUrlTrailingSlash : true) as boolean;

const notificationLogic = ref(new ConsumerLogicApi(
  consumerUrl,
  consumerTrailingSlash,
));

notificationLogic.value.getFullDefinition();

const actionViewLicense = async (): Promise<boolean> => {
  await FormConsumerOneShotApi({ url: licenseConsumerUrl, trailingSlash: licenseConsumerUrlTrailingSlash, pk: 'new' });
  return true;
};

const actionSendNotification = async (): Promise<boolean> => {
  await FormConsumerOneShotApi({
    url: consumerUrl,
    trailingSlash: consumerTrailingSlash,
    pk: 'new',
  });
  return true;
};

const actionAddNotification = async (): Promise<boolean> => {
  await FormConsumerOneShotApi({
    url: consumerUrl,
    trailingSlash: consumerTrailingSlash,
    pk: 'new',
    query: { save: 1 },
    useQueryInRetrieveOnly: true,
  });
  return true;
};

const licenseConsumedShown = ref(false);
const notificationId = ref(Date.now());

const showLicenseConsumed = () => {
  if (!licenseConsumedShown.value) {
    notificationId.value = Date.now();
    licenseConsumedShown.value = true;
    showNotification(
      gettext('License consumed'),
      gettext('You cannot generate new notifications. Please contact support.'),
      'error',
      -1,
      notificationId.value,
    );
  }
};

let intervalCheckLicense: NodeJS.Timeout | undefined;
onMounted(() => {
  intervalCheckLicense = setInterval(() => {
    apiClient.get(
      `${licenseConsumerUrl}/new${licenseConsumerUrlTrailingSlash ? '/' : ''}?format=json&decorate-max-price=1`,
    ).then(
      (licenseResponse) => {
        if (licenseResponse.data.remaining_credit < licenseResponse.data.max_notification_price) {
          showLicenseConsumed();
          return;
        }
        closeNotification(notificationId.value);
      },
    );
  }, 15000);
});

onUnmounted(() => clearInterval(intervalCheckLicense));

// const actionSendNow = async (action:Action, payload: FormPayload): Promise<boolean> => {
// TODO: WAITING FOR ISSUE https://taiga.velis.si/project/velis74-dynamic-forms/issue/858
//   console.log(Math.random(), 'actionSendNow', action, payload);
//   // eslint-disable-next-line no-debugger
//   debugger;
//   // apiClient.post(consumerUrl + (consumerTrailingSlash ? '/' : ''), payload);
//   return true;
// };
const dialogHandlers = {
  send: async (action: Action, payload: FormPayload): Promise<boolean> => {
    console.log(Math.random(), 'actionSendNow', action, payload);
    // eslint-disable-next-line no-debugger

    // apiClient.post(consumerUrl + (consumerTrailingSlash ? '/' : ''), payload);
    return true;
  },
  cancel: async (action: Action, payload: FormPayload): Promise<boolean> => {
    console.log(Math.random(), 'actionCancel', action, payload);
    // eslint-disable-next-line no-debugger

    // apiClient.post(consumerUrl + (consumerTrailingSlash ? '/' : ''), payload);
    return true;
  },
};

const { handler } = useActionHandler();

handler
  .register('view-license', actionViewLicense)
  // .register('send-now', dialogHandlers.actionSendNow)
  .register('add-notification', actionAddNotification)
  .register('send-notification', actionSendNotification);

// TODO: remove linter ignores below when you know how to
</script>

<template>
  <div class="overflow-y-auto">
    <!--suppress TypeScriptValidateTypes -->
    <!-- @vue-ignore -->
    <APIConsumer
      :consumer="notificationLogic"
      :display-component="ComponentDisplay.TABLE"
      :dialog-handlers="dialogHandlers"
    />
    <ModalView/>
  </div>
</template>
